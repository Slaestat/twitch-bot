<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<title>Bot Test Web</title>
<style>
body { font-family: sans-serif; margin: 20px; }
#chat { border: 1px solid #ccc; height: 300px; overflow-y: scroll; padding: 10px; margin-bottom: 10px; }
input { padding: 5px; width: 300px; }
button { padding: 5px 10px; }

.calabozo {
    display: flex;
    flex-direction: column;
    justify-content: center;
    align-items: center;
    gap: 15px;
}

.calabozo .header {
    width: 100%;
    display: flex;
    flex-direction: row;
    justify-content: space-around;
    align-items: center;
}

.calabozo .btns {
    width: 100%;
    display: flex;
    flex-direction: row;
    justify-content: space-around;
    align-items: center;
}

.calabozo .btns .btn {
    padding: 10px;
    border-radius: 30px;
    cursor: pointer;
}

.calabozo .btns .spawnMinor {
    background-color: #FF3400;
    color: #ffffff;
}

.calabozo .btns .spawnMajor {
    background-color: #FF8800;
    color: #ffffff;
}

.calabozo .btns .spawnBoss {
    background-color: #FFD900;
}
</style>
<script src="calabozo.js" ></script>
</head>
<body>

<h2>Chat Twitch Bot</h2>
<div id="chat"></div>
<input id="msgInput" placeholder="Escribe mensaje..." />
<button onclick="sendMessage()">Enviar</button>
<div class="calabozo">
    <div class="header">
        <h1>Calabozo control panel</h1>
        <div> ^ </div>
    </div>
    <div class="btns">
        <div class="btn spawnMinor"> Spawn minor enemy </div>
        <div class="btn spawnMajor"> Spawn major enemy </div>
        <div class="btn spawnBoss"> Spawn boss enemy </div>
    </div>
</div>

<script src="/socket.io/socket.io.js"></script>
<script>
    const socket = io();
    let activeUsers = [];

    const chatDiv = document.querySelector('#chat');

    socket.on('chat-message', (data) => {
        const userExist = activeUsers.some( u => u[0] === data.user );

        if ( !userExist ) {

            if ( activeUsers.length == 0 ) {
                activeUsers.push( [data.user, 1000] );
                addLog(`user added: ${data.user}`);
            } else {
                activeUsers.push( [data.user, 0] );
                addLog(`user added: ${data.user}`);
            }

        }

        if ( data.message.startsWith('!damePts') ) {
            damePts( data.user, 100 );
        }

        /* CALABOZO SETUP*/

        //Creating player
        if ( data.message.startsWith('!calabozo-') ) {
            if ( !calabozo_player[ data.user ]) {
                if ( data.message.split('-')[1].toLocaleLowerCase().startsWith('w') ) {
                    calabozo_newPlayer( data.user, 'warrior' );
                    addLog( `new user for 'calabozo' has been created ( ${data.user} ) as a new warrior` );
                } else if ( data.message.split('-')[1].toLocaleLowerCase().startsWith('s') ) {
                    calabozo_newPlayer( data.user, 'spellcaster' );
                    addLog( `new user for 'calabozo' has been created ( ${data.user} ) as a new spellcaster` );
                } else if ( data.message.split('-')[1].toLocaleLowerCase().startsWith('b') ) {
                    calabozo_newPlayer( data.user, 'beast' );
                    addLog( `new user for 'calabozo' has been created ( ${data.user} ) as a new beast` );
                } else {
                    socket.emit('send-message', `Sorry ${ data.user}, no class defined, write '!calabozo-w' for warrior, '!calabozo-s' for spellcaster or '!calabozo-b' fpr beast` );
                }
            } else {
                socket.emit('send-message', `sorry ${ data.user } already exist`);
            }
        }

        //Pelea
        if ( data.message.startsWith('!pelea') ) {
            if ( pelea_activa ) {
                calabozoPelea( data.user, enemy_live);
            } else {
                socket.emit('send-message', `no hay enemigos en chat... no del juego calabozo al menos`);
            }
        }

    }); 

    //Spawning enemy
    document.querySelector('.spawnMinor').addEventListener('click', function() {
        spawnMinor();
    })

    function sendMessage( message ) {
        socket.emit('send-message', message);
    }

    function damePts( user, pts ) {
        let userIndex = activeUsers.findIndex( u => u[0] === user );
        if(userIndex === -1) return;

        activeUsers[ userIndex ] = [ user, activeUsers[ userIndex ][1] + pts ];
        addLog( `added ${pts} points to ${user}` );

    }

    function addLog( message ) {
        chatDiv.innerHTML += `<p> ${message} </p>`;
        chatDiv.scrollTop = chatDiv.scrollHeight;
    }
</script>

</body>
</html>
