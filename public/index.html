<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<title>Bot Test Web</title>
<style>
    body { font-family: sans-serif; margin: 20px; }
    #chat { border: 1px solid #ccc; height: 300px; overflow-y: scroll; padding: 10px; margin-bottom: 10px; }
    input { padding: 5px; width: 300px; }
    button { padding: 5px 10px; }

    .calabozo {
        display: flex;
        flex-direction: column;
        justify-content: center;
        align-items: center;
        gap: 15px;
        border: 1px solid;
        padding: 15px;
        display: none;
    }

    .calabozo .header {
        width: 100%;
        display: flex;
        flex-direction: row;
        justify-content: space-around;
        align-items: center;
    }

    .calabozo .btns {
        width: 100%;
        display: flex;
        flex-direction: row;
        justify-content: space-around;
        align-items: center;
    }

    .calabozo .btns .btn {
        padding: 10px;
        border-radius: 30px;
        cursor: pointer;
    }

    .calabozo .btns .spawnMinor {
        background-color: #FF3400;
        color: #ffffff;
    }

    .calabozo .btns .spawnMajor {
        background-color: #FF8800;
        color: #ffffff;
    }

    .calabozo .btns .spawnBoss {
        background-color: #FFD900;
    }

    .quickPoll {
        display: flex;
        flex-direction: column;
        justify-content: center;
        align-items: center;
        gap: 15px;
        border: 1px solid;
        padding: 15px;
    }

    .quickPoll .header {
        width: 100%;
        display: flex;
        flex-direction: row;
        justify-content: space-around;
        align-items: center;
    }

    .quickPoll .instructive {
        text-align: center;
    }

    .quickPoll .btns {
        width: 100%;
        display: flex;
        flex-direction: row;
        justify-content: space-around;
        align-items: center;
    }

    .quickPoll .btns .btn {
        padding: 10px;
        margin: 10px 0 0 0;
        border-radius: 30px;
        cursor: pointer;
    }

    .quickPoll .pollStart {
        background-color: lightblue;
    }

    .quickPoll .pollEnd {
        background-color: lightcoral;
    }
</style>
</head>
<body>

<h2>Chat Twitch Bot</h2>
<div id="chat"></div>
<input id="msgInput" placeholder="Escribe mensaje..." />
<button onclick="sendMessage()">Enviar</button>
<div class="calabozo">
    <div class="header">
        <h1>Calabozo control panel</h1>
        <div> ^ </div>
    </div>
    <div class="btns">
        <div class="btn spawnMinor"> Spawn minor enemy </div>
        <div class="btn spawnMajor"> Spawn major enemy </div>
        <div class="btn spawnBoss"> Spawn boss enemy </div>
    </div>
</div>
<div class="quickPoll">
    <div class="header">
        <h1>Poll rapida</h1>
    </div>
    <div class="instructive">
        Este apartado es para iniciar un rapido conteo ( hasta 5 opciones ), poniendote de acuerdo con chat sobre las opciones
        y mientras la encuesta este activa leera chat y contara los numeros del 1 a 5 colocados.
    </div>
    <div class="btns">
        <div class="btn pollStart"> Iniciar encuesta </div>
        <div class="btn pollEnd"> Terminar encuesta </div>
    </div>
</div>

<script src="/socket.io/socket.io.js"></script>
<script src="streamSetup.js"></script>
<script src="calabozo.js"></script>
<script>
    const socket = io();
    let activeUsers = [],
        activePoll = false,
        pollUsers = [],
        quickPollVaules = {
            "1" : 0,
            "2" : 0,
            "3" : 0,
            "4" : 0,
            "5" : 0
        };

    const chatDiv = document.querySelector('#chat');

    socket.on('chat-message', (data) => {
        const userExist = activeUsers.some( u => u[0] === data.user );

        if ( !userExist ) {

            if ( activeUsers.length == 0 ) {
                activeUsers.push( [data.user, 1000] );
                addLog(`user added: ${data.user}`);
            } else {
                activeUsers.push( [data.user, 0] );
                addLog(`user added: ${data.user}`);
            }

        }

        /* Regular commands */
        if ( data.message.startsWith('!so') ) {
            if( mods.includes( data.user.toLowerCase() ) ){
                shoutout( data.message.split(' ')[1] );
            }
        }

        if ( data.message.startsWith('!damePts') ) {
            damePts( data.user, 100 );
        }

        /* CALABOZO SETUP */

        //Calabozo Menu
        if ( data.message.startsWith('!calabozo') ) {
            dungeon_instruction( socket );
        }

        //Creating player
        if ( data.message.startsWith('!create-') ) {
            dungeon_createPlayer( data );
        }

        //Pelea
        if ( data.message.startsWith('!pelea') ) {
            dungeon_fight( data );
        }

        /* POLL COUNT */
        if ( data.message.startsWith('1') ) {
            activePoll ? quickPollVaules['1']++ : null;
        }
        if ( data.message.startsWith('2') ) {
            activePoll ? quickPollVaules['2']++ : null;
        }
        if ( data.message.startsWith('3') ) {
            activePoll ? quickPollVaules['3']++ : null;
        }
        if ( data.message.startsWith('4') ) {
            activePoll ? quickPollVaules['4']++ : null;
        }
        if ( data.message.startsWith('5') ) {
            activePoll ? quickPollVaules['5']++ : null;
        }

    }); 

    //Spawning enemy
    document.querySelector('.spawnMinor').addEventListener('click', function() {
        if ( !pelea_activa ) {
            spawnEnemy( 'minor' );
        } else {
            addLog( `already a monster in chat: ${ monster_active }` );
            socket.emit('send-message', `${ monster_active } still lurking in chat, fight it with "!pelea" in chat`);
        }
    });
    
    document.querySelector('.spawnMajor').addEventListener('click', function() {
        if ( !pelea_activa ) {
            spawnEnemy( 'major' );
        } else {
            addLog( `already a monster in chat: ${ monster_active }` );
            socket.emit('send-message', `${ monster_active } still lurking in chat, fight it with "!pelea" in chat`);
        }
    });
    
    document.querySelector('.spawnBoss').addEventListener('click', function() {
        if ( !pelea_activa ) {
            spawnEnemy( 'boss' );
        } else {
            addLog( `already a monster in chat: ${ monster_active }` );
            socket.emit('send-message', `${ monster_active } still lurking in chat, fight it with "!pelea" in chat`);
        }
    });

    /* POLL SETUP */
    document.querySelector('.btn.pollStart').addEventListener( 'click', function() {
        activePoll = true;

        addLog( `Encuesta iniciada` );
        sendMessage( `Encuesta iniciada` );
    })

    document.querySelector('.btn.pollEnd').addEventListener('click', function() {
        let ganador = Object.entries( quickPollVaules ).reduce((a, b) => 
            b[1] > a[1] ? b : a
            )[0];
            
        addLog( `El ganador es: ${ganador}` );
        sendMessage( `El ganador es: ${ganador}` );
        activePoll = false;
        quickPollVaules = {
            "1" : 0,
            "2" : 0,
            "3" : 0,
            "4" : 0,
            "5" : 0
        };
    })

    function sendMessage( message ) {
        socket.emit('send-message', message);
    }

    function damePts( user, pts ) {
        let userIndex = activeUsers.findIndex( u => u[0] === user );
        if(userIndex === -1) return;

        activeUsers[ userIndex ] = [ user, activeUsers[ userIndex ][1] + pts ];
        addLog( `added ${pts} points to ${user}` );

    }

    function addLog( message ) {
        chatDiv.innerHTML += `<p> ${message} </p>`;
        chatDiv.scrollTop = chatDiv.scrollHeight;
    }
</script>

</body>
</html>
